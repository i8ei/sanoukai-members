---
import BaseLayout from '../../layouts/BaseLayout.astro';
import MemberCard from '../../components/MemberCard.astro';
import { getMembers } from '../../lib/members';
import { BASE } from '../../lib/config';

const members = await getMembers();
const normalizeText = (value: string) => value.toLowerCase().replace(/\s+/g, ' ').trim();
const areaOptions = Array.from(
  new Map(
    members.map((member) => {
      const code = String(member.area?.code ?? 'default').trim() || 'default';
      const label = String(member.area?.label ?? 'エリア不明').trim() || 'エリア不明';
      return [code, label];
    })
  ).entries()
).map(([code, label]) => ({ code, label }));
---

<BaseLayout title="会員一覧 | 佐賀県農業法人協会">
  <section>
    <!-- Page Header with decorative background -->
    <div class="relative -mx-4 -mt-6 mb-8 overflow-hidden rounded-none bg-gradient-to-br from-brand-dark via-brand to-leaf px-4 py-12 sm:-mx-6 sm:px-6 md:-mt-10 md:mb-10 md:py-16">
      <div class="absolute inset-0 opacity-10" style="background-image: url(&quot;data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M20 5 C17 12, 12 15, 8 20 C12 18, 17 16, 20 10 C23 16, 28 18, 32 20 C28 15, 23 12, 20 5z' fill='white' /%3E%3C/svg%3E&quot;);"></div>
      <div class="relative z-10">
        <h1 class="text-2xl font-black tracking-tight text-white md:text-3xl animate-fade-in-up">会員一覧</h1>
        <p class="mt-2 text-sm text-white/80 animate-fade-in-up stagger-1">会員法人の基本情報、主な生産品、販売チャネルを掲載しています。</p>
        <div class="mt-3 flex flex-wrap items-center gap-2">
          <p class="inline-flex items-center gap-1.5 rounded-full bg-white/15 px-3 py-1 text-xs font-medium text-white/90 backdrop-blur-sm animate-fade-in-up stagger-2">
            <span class="h-1.5 w-1.5 rounded-full bg-sun"></span>
            {members.length} 法人を掲載中
          </p>
          <a href={`${BASE}members/map/`} class="inline-flex items-center gap-1 rounded-full border border-white/35 bg-white/15 px-4 py-1.5 text-xs font-semibold text-white no-underline backdrop-blur-sm transition hover:bg-white/25 hover:no-underline">🗺 地図を見る</a>
        </div>
      </div>
    </div>

    <div class="mb-6 rounded-xl border border-line bg-card p-4 shadow-card">
      <div class="grid grid-cols-1 gap-3 sm:grid-cols-2 lg:grid-cols-[minmax(0,180px),1fr,auto]">
        <label class="text-sm font-medium text-ink" for="member-area-filter">
          エリア
          <select id="member-area-filter" class="mt-1 w-full rounded-lg border border-line bg-white px-3 py-2 text-sm text-ink focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/20">
            <option value="">すべて</option>
            {areaOptions.map((area) => (
              <option value={area.code}>{area.label}</option>
            ))}
          </select>
        </label>
        <label class="text-sm font-medium text-ink" for="member-keyword-filter">
          キーワード（法人名・生産品）
          <input id="member-keyword-filter" type="search" placeholder="例: いちご" class="mt-1 w-full rounded-lg border border-line bg-white px-3 py-2 text-sm text-ink placeholder:text-ink-soft focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/20" />
        </label>
        <div class="flex flex-col items-stretch gap-2 sm:items-end">
        <label class="inline-flex items-center gap-2 rounded-lg border border-line bg-bg px-3 py-2 text-sm text-ink">
          <input id="member-website-only" type="checkbox" class="h-4 w-4 rounded border-line text-brand focus:ring-brand/30" />
          公式サイトありのみ
        </label>
          <button id="member-filter-reset" type="button" class="h-10 w-full rounded-lg border border-line bg-bg px-4 text-sm font-medium text-ink transition-colors hover:bg-white sm:w-auto">
            リセット
          </button>
        </div>
      </div>
      <p id="member-filter-count" class="mt-3 text-sm text-ink-soft" aria-live="polite">{members.length} 件表示</p>
    </div>

    <p id="member-filter-empty" class="mb-6 hidden rounded-lg border border-dashed border-line bg-bg px-4 py-5 text-sm text-ink-soft">
      条件に一致する会員が見つかりませんでした。
    </p>

    <div id="members-list" class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
      {members.map((member) => (
        <div
          class="member-card-item"
          data-area={String(member.area?.code ?? 'default').trim() || 'default'}
          data-has-website={member.web_presence?.website ? '1' : '0'}
          data-search={normalizeText(
            [
              String(member.name ?? ''),
              ...(member.products ?? []).map((product) => String(product.name ?? product.category ?? '')),
            ].join(' ')
          )}
        >
          <MemberCard member={member} href={`${BASE}members/${encodeURIComponent(member.id)}/`} />
        </div>
      ))}
    </div>
  </section>

  <script is:inline>
    (() => {
      const areaFilter = document.getElementById('member-area-filter');
      const keywordFilter = document.getElementById('member-keyword-filter');
      const resetButton = document.getElementById('member-filter-reset');
      const websiteOnly = document.getElementById('member-website-only');
      const countText = document.getElementById('member-filter-count');
      const emptyState = document.getElementById('member-filter-empty');
      const cards = Array.from(document.querySelectorAll('.member-card-item'));

      if (!areaFilter || !keywordFilter || !resetButton || !countText || !emptyState || !websiteOnly || cards.length === 0) return;

      const normalize = (value) => value.toLowerCase().replace(/\s+/g, ' ').trim();

      const applyFilter = () => {
        const selectedArea = areaFilter.value;
        const keyword = normalize(keywordFilter.value);
        const websiteRequired = websiteOnly.checked;
        let visibleCount = 0;

        cards.forEach((card) => {
          const area = card.getAttribute('data-area') || 'default';
          const search = card.getAttribute('data-search') || '';
          const hasWebsite = (card.getAttribute('data-has-website') || '0') === '1';
          const areaMatch = selectedArea === '' || area === selectedArea;
          const keywordMatch = keyword === '' || search.includes(keyword);
          const websiteMatch = !websiteRequired || hasWebsite;
          const isVisible = areaMatch && keywordMatch && websiteMatch;
          card.hidden = !isVisible;
          if (isVisible) visibleCount += 1;
        });

        countText.textContent = visibleCount + ' 件表示';
        emptyState.classList.toggle('hidden', visibleCount !== 0);
      };

      areaFilter.addEventListener('change', applyFilter);
      keywordFilter.addEventListener('input', applyFilter);
      websiteOnly.addEventListener('change', applyFilter);
      resetButton.addEventListener('click', () => {
        areaFilter.value = '';
        keywordFilter.value = '';
        websiteOnly.checked = false;
        applyFilter();
      });
    })();
  </script>
</BaseLayout>
