---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Badge from "../../components/Badge.astro";
import {
  briefProducts,
  fallback,
  getMemberById,
  getMembers,
  isPresent,
} from "../../lib/members";
import { BASE } from "../../lib/config";

export async function getStaticPaths() {
  const members = await getMembers();
  const paths: Array<{ params: { id: string } }> = [];
  const seen = new Set<string>();
  for (const member of members) {
    const ids = [member.id, ...(member.legacy_ids ?? [])].filter(
      Boolean,
    ) as string[];
    for (const id of ids) {
      if (seen.has(id)) continue;
      seen.add(id);
      paths.push({ params: { id } });
    }
  }
  return paths;
}

const id = Astro.params.id ?? "";
const member = await getMemberById(id);

if (!member) {
  throw new Error(`Member not found: ${id}`);
}

const toTextList = (items: unknown): string[] => {
  if (!Array.isArray(items)) return [];
  return items
    .map((value) => String(value ?? "").trim())
    .filter((value) => value.length > 0);
};

const channels = toTextList(member.sales_channels);
const productNames = (member.products ?? [])
  .map((product) => product.name || product.category)
  .filter((value): value is string => Boolean(value && value.trim()));
const summary = member.business?.summary;
const oneLineIntro = isPresent(summary)
  ? String(summary)
  : `${fallback(member.name)}ã®ç´¹ä»‹ãƒšãƒ¼ã‚¸ã§ã™ã€‚`;
const certifications = toTextList(member.certifications);
const awards = (member.awards ?? []).filter((award) => isPresent(award?.title));
const areaCode = member.area?.code ?? "default";
const dotClass = `area-dot area-dot-${areaCode}`;
---

<BaseLayout title={`${fallback(member.name)} | ä¼šå“¡è©³ç´°`}>
  <section class="space-y-5 md:space-y-6">
    <!-- â•â•â• Member Header â•â•â• -->
    <article
      class="relative overflow-hidden rounded-2xl border border-line bg-gradient-to-br from-brand-dark via-brand to-leaf p-6 shadow-card md:p-8"
    >
      <div
        class="absolute inset-0 opacity-5"
        style="background-image: url(&quot;data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='30' cy='30' r='2' fill='white' /%3E%3C/svg%3E&quot;);"
      >
      </div>
      <div class="relative z-10">
        <h1
          class="mt-2 text-2xl font-black text-white md:text-3xl animate-fade-in-up"
        >
          {fallback(member.name)}
        </h1>

        <div class="mt-3 flex flex-wrap items-center gap-2">
          <span
            class="inline-flex items-center gap-1.5 rounded-full border border-white/25 bg-white/10 px-3 py-1 text-xs font-semibold text-white"
          >
            <span class={dotClass}></span>
            {fallback(member.area?.label)}
          </span>
        </div>

        <p
          class="mt-4 rounded-xl bg-white/10 p-3 text-sm leading-7 text-white/90 backdrop-blur-sm"
        >
          {oneLineIntro}
        </p>
      </div>
    </article>

    <!-- â•â•â• Images â•â•â• -->
    {(member.images ?? []).length > 0 && (
      <article class="rounded-xl overflow-hidden border border-line shadow-card">
        <div class="grid gap-1 {(member.images ?? []).length === 1 ? '' : 'sm:grid-cols-2'}">
          {(member.images ?? []).map((img) => (
            <figure class="relative aspect-video overflow-hidden bg-bg-soft">
              <img
                src={img.path}
                alt={img.caption ?? fallback(member.name)}
                class="h-full w-full object-cover"
                loading="lazy"
              />
              {img.caption && (
                <figcaption class="absolute bottom-0 left-0 right-0 bg-black/40 px-3 py-1.5 text-xs text-white backdrop-blur-sm">
                  {img.caption}
                </figcaption>
              )}
            </figure>
          ))}
        </div>
      </article>
    )}

    <!-- â•â•â• Basic Info â•â•â• -->
    <article
      class="accent-border-brand rounded-xl border border-line bg-card p-5 shadow-card md:p-6 animate-fade-in-up stagger-1"
    >
      <h2 class="flex items-center gap-2 text-sm font-bold text-ink">
        <span
          class="flex h-7 w-7 items-center justify-center rounded-lg bg-brand/10 text-sm"
          >ğŸ“‹</span
        >
        åŸºæœ¬æƒ…å ±
      </h2>
      <dl class="mt-4 grid gap-3 text-sm sm:grid-cols-2">
        <div class="rounded-xl bg-bg-soft p-3">
          <dt class="text-xs font-medium text-ink-soft">æ³•äººç¨®åˆ¥</dt>
          <dd class="mt-1 font-medium text-ink">
            {fallback(member.entity_type)}
          </dd>
        </div>
        <div class="rounded-xl bg-bg-soft p-3">
          <dt class="text-xs font-medium text-ink-soft">æ‰€åœ¨åœ°</dt>
          <dd class="mt-1 font-medium text-ink">
            {fallback(member.location?.address || member.location?.city)}
          </dd>
        </div>
        <div class="rounded-xl bg-bg-soft p-3">
          <dt class="text-xs font-medium text-ink-soft">ä»£è¡¨è€…</dt>
          <dd class="mt-1 font-medium text-ink">
            {fallback(member.contact?.representative ?? undefined)}
          </dd>
        </div>
        <div class="rounded-xl bg-bg-soft p-3">
          <dt class="text-xs font-medium text-ink-soft">é›»è©±</dt>
          <dd class="mt-1 font-medium text-ink">
            {fallback(member.contact?.phone ?? undefined)}
          </dd>
        </div>
      </dl>
    </article>

    <!-- â•â•â• Products â•â•â• -->
    <article
      class="accent-border-leaf rounded-xl border border-line bg-card p-5 shadow-card md:p-6 animate-fade-in-up stagger-2"
    >
      <h2 class="flex items-center gap-2 text-sm font-bold text-ink">
        <span
          class="flex h-7 w-7 items-center justify-center rounded-lg bg-leaf-pale text-sm"
          >ğŸŒ±</span
        >
        ç”Ÿç”£
      </h2>
      {
        productNames.length > 0 ? (
          <ul class="mt-4 space-y-2 text-sm text-ink">
            {(member.products ?? []).map((product) => (
              <li class="rounded-xl border border-line bg-card-soft p-3.5 transition-colors hover:bg-earth-pale">
                <p class="font-bold">
                  {fallback(product.name || product.category)}
                </p>
                {isPresent(product.description) ? (
                  <p class="mt-1 text-ink-soft leading-relaxed">
                    {product.description}
                  </p>
                ) : null}
              </li>
            ))}
          </ul>
        ) : (
          <p class="mt-4 text-sm text-ink">æƒ…å ±æº–å‚™ä¸­</p>
        )
      }
    </article>

    <!-- â•â•â• Sales â•â•â• -->
    <article
      class="accent-border-sun rounded-xl border border-line bg-card p-5 shadow-card md:p-6 animate-fade-in-up stagger-3"
    >
      <h2 class="flex items-center gap-2 text-sm font-bold text-ink">
        <span
          class="flex h-7 w-7 items-center justify-center rounded-lg bg-sun-pale text-sm"
          >ğŸ›’</span
        >
        è²©å£²
      </h2>
      <div class="mt-4 flex flex-wrap gap-2">
        {
          channels.length > 0 ? (
            channels.map((channel) => <Badge label={channel} />)
          ) : (
            <p class="text-sm text-ink">æƒ…å ±æº–å‚™ä¸­</p>
          )
        }
      </div>
      <div class="mt-5 grid gap-3 text-sm sm:grid-cols-2">
        <div class="rounded-xl bg-bg-soft p-3">
          <p class="text-xs font-medium text-ink-soft">Webã‚µã‚¤ãƒˆ</p>
          {
            isPresent(member.web_presence?.website) ? (
              <a
                href={member.web_presence?.website ?? "#"}
                target="_blank"
                rel="noreferrer"
                class="mt-1 inline-block break-all text-sm"
              >
                {member.web_presence?.website}
              </a>
            ) : (
              <p class="mt-1 text-ink">æƒ…å ±æº–å‚™ä¸­</p>
            )
          }
        </div>
      </div>
    </article>

    <!-- â•â•â• Notes â•â•â• -->
    <article
      class="accent-border-water rounded-xl border border-line bg-card p-5 shadow-card md:p-6 animate-fade-in-up stagger-4"
    >
      <h2 class="flex items-center gap-2 text-sm font-bold text-ink">
        <span
          class="flex h-7 w-7 items-center justify-center rounded-lg bg-water/10 text-sm"
          >ğŸ“</span
        >
        è£œè¶³ãƒ¡ãƒ¢
      </h2>
      <div class="mt-4 space-y-3 text-sm text-ink">
        <div class="rounded-xl bg-bg-soft p-3">
          <p class="text-xs font-medium text-ink-soft">èªè¨¼</p>
          <p class="mt-1">
            {
              certifications.length > 0
                ? certifications.join(" / ")
                : "æƒ…å ±æº–å‚™ä¸­"
            }
          </p>
        </div>
        <div class="rounded-xl bg-bg-soft p-3">
          <p class="text-xs font-medium text-ink-soft">å—è³æ­´</p>
          <p class="mt-1">
            {
              awards.length > 0
                ? awards
                    .map((award) =>
                      [award.year, award.title]
                        .filter((part) => isPresent(part))
                        .join(" "),
                    )
                    .join(" / ")
                : "æƒ…å ±æº–å‚™ä¸­"
            }
          </p>
        </div>
      </div>
    </article>

    <!-- â•â•â• Back Link â•â•â• -->
    <div>
      <a
        href={`${BASE}members/`}
        class="inline-flex items-center gap-2 rounded-xl bg-brand px-5 py-2.5 text-sm font-bold text-white no-underline shadow-sm transition-all duration-200 hover:bg-brand-dark hover:shadow-md hover:no-underline hover:-translate-y-0.5"
      >
        â† ä¼šå“¡ä¸€è¦§ã«æˆ»ã‚‹
      </a>
    </div>
  </section>
</BaseLayout>
